name: $(Build.SourceBranchName).$(date:yyyyMMdd)$(rev:.r)

resources:
- repo: self
  clean: all
  fetchDepth: 1

trigger:
  branches:
   include:
    - main/*
  paths:
   include:
    - backend/*

variables:
  - group: devopslab


pool:
  name: devopslab
steps:
- task: qetza.replacetokens.replacetokens-task.replacetokens@4
  displayName: 'Replace variables'
  inputs:
    rootDirectory: backend
    targetFiles: |
     deployment.yaml
     app.js
    tokenPattern: custom

- task: Docker@2
  displayName: build
  inputs:
    containerRegistry: 'gcp-registry'
    repository: 'the-tree-beneath-329315/devops/backend'
    command: build
    Dockerfile: backend/Dockerfile

- task: CmdLine@2
  displayName: "Perform Security Scan"
  continueOnError: true
  inputs:
    script: |
      docker run \
      -v "$(Build.SourcesDirectory):/app:cached" \
      -v "$(Build.ArtifactStagingDirectory):/reports:cached" \
      shiftleft/sast-scan scan --src /app \
      --out_dir /reports/CodeAnalysisLogs

- task: PublishBuildArtifacts@1
  displayName: "Publish analysis logs"
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/CodeAnalysisLogs'
    ArtifactName: 'CodeAnalysisLogs Backend container'
    TargetPath: 'Container'

- task: Docker@2
  displayName: push
  inputs:
    containerRegistry: 'gcp-registry'
    repository: 'the-tree-beneath-329315/devops/backend'
    command: push

- task: KubernetesManifest@0
  displayName: deploy
  inputs:
    kubernetesServiceConnection: k8s
    manifests: backend/deployment.yaml

- task: Kubernetes@1
  displayName: 'kubectl apply'
  inputs:
    kubernetesServiceEndpoint: k8s
    command: apply
    useConfigurationFile: true
    configuration: backend/deployment.yaml
